<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowd Monitor | Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="dashboard">
        <header>
            <h1>Crowd Monitor</h1>
            <p><span class="status-indicator"></span>Live Sensor Feed</p>
        </header>

        <div class="stats-grid">
            <div class="card card-entered">
                <h2>People Entered</h2>
                <div class="value" id="entered">0</div>
            </div>
            <div class="card card-departed">
                <h2>People Departed</h2>
                <div class="value" id="departed">0</div>
            </div>
            <div class="card card-inside">
                <h2>Present Inside</h2>
                <div class="value" id="inside">0</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="historyChart"></canvas>
        </div>

        <div class="controls">
            <button class="btn-reset" onclick="sendReset()">SEND RESET (0)</button>
        </div>
    </div>

    <script>
        // Chart.js Setup
        const ctx = document.getElementById('historyChart').getContext('2d');
        const historyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'People Inside (Historical)',
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    data: [],
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: { color: '#94a3b8' },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#94a3b8' },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#f8fafc' } }
                }
            }
        });

        async function updateStats() {
            try {
                const response = await fetch('/data');
                const data = await response.json();

                document.getElementById('entered').textContent = data.entered;
                document.getElementById('departed').textContent = data.departed;
                document.getElementById('inside').textContent = data.inside;

                // Update Chart
                updateChart();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        async function updateChart() {
            try {
                const res = await fetch('/history');
                const historyData = await res.json();

                historyChart.data.labels = historyData.labels;
                historyChart.data.datasets[0].data = historyData.values;
                historyChart.update('none'); // Update without animation for performance
            } catch (e) {
                console.error('Chart update error:', e);
            }
        }

        async function sendReset() {
            const btn = document.querySelector('.btn-reset');
            const originalText = btn.textContent;

            try {
                btn.textContent = 'SENDING...';
                btn.disabled = true;

                const response = await fetch('/reset', { method: 'POST' });
                const result = await response.json();

                if (result.status === 'success') {
                    alert('Reset command (0) successfully sent to ESP32!');
                }
            } catch (error) {
                alert('Failed to send reset command.');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Poll every 2 seconds
        setInterval(updateStats, 2000);
        // Initial load
        updateStats();
    </script>
</body>

</html>